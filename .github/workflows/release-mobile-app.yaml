name: Mobile fastlane release workflow
on:
  push:
    tags:
      - mobile/v*
  workflow_dispatch:

jobs:
  release-android-mobile:
    name: release-android-mobile
    runs-on: macos-latest #orai-self-hosted
    strategy:
      matrix:
        node-version: [16.14.0]
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.8.0
        with:
          access_token: ${{ github.token }}
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - name: Restore node_modules from cache
        uses: actions/cache@v2
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-
      - name: Checkout submodule repo
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Install dependencies # install project deps with --frozen-lockfile to make sure we will have the same packages version ( very recommended  on running yarn install on ci)
        run: yarn install --frozen-lockfile
      - name: Install mobile packages
        working-directory: packages/mobile
        run: yarn --silent
      - name: restore lerna
        uses: actions/cache@v3
        with:
          path: '**/node_modules'
          key: ${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
      - name: Build Libs
        run: yarn build:libs
      - name: Build provider
        working-directory: packages/mobile
        run: yarn build:provider
      - name: Setup Ruby 
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.6.10
          bundler-cache: true
      - name: Setup JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle
      - name: Grant execute permission for gradlew
        working-directory: packages/mobile/android
        run: chmod +x gradlew
      - name: Decode Keystore File
        uses: timheuer/base64-to-file@v1
        id: android_keystore
        with:
          fileName: "OWalletKeystore"
          encodedString: "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"
          fileDir: 'packages/mobile/android/fastlane'
      - name: Setup Fastlane android
        working-directory: packages/mobile/android/fastlane
        run: cd .. && bundle update && fastlane release
        env:
          JSON_KEY_DATA: ${{ secrets.GOOGLE_ACCOUNT_SERVICE }}
          DISCORD_HOOK_ID: ${{ secrets.DISCORD_MOBILE_WEBHOOK_ID }}
          DISCORD_HOOK_TOKEN: ${{ secrets.DISCORD_MOBILE_WEBHOOK_TOKEN }}
          ALIAS: ${{ secrets.ALIAS }}
          PASS_KEY_STORE: ${{ secrets.PASS_KEY_STORE }}
          PASS_ALIAS_KEY_STORE: ${{ secrets.PASS_KEY_STORE }}
          FILE_PATH: "/OWalletKeystore"
  # release-ios-mobile:
  #   name: release-ios-mobile
  #   runs-on: macos-latest #orai-self-hosted
  #   strategy:
  #     matrix:
  #       node-version: [16.14.0]
  #   steps:
  #     - name: Cancel Previous Runs
  #       uses: styfle/cancel-workflow-action@0.8.0
  #       with:
  #         access_token: ${{ github.token }}
  #     - name: Use Node.js ${{ matrix.node-version }}
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: ${{ matrix.node-version }}
  #     - name: Get yarn cache directory path
  #       id: yarn-cache-dir-path
  #       run: echo "::set-output name=dir::$(yarn cache dir)"
  #     - name: Restore node_modules from cache
  #       uses: actions/cache@v2
  #       id: yarn-cache
  #       with:
  #         path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
  #         key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-yarn-
  #     - name: Checkout submodule repo
  #       uses: actions/checkout@v3
  #       with:
  #         submodules: recursive
  #     - name: Install dependencies # install project deps with --frozen-lockfile to make sure we will have the same packages version ( very recommended  on running yarn install on ci)
  #       run: yarn install --frozen-lockfile
  #     - name: Install mobile packages
  #       working-directory: packages/mobile
  #       run: yarn --silent
  #     - name: restore lerna
  #       uses: actions/cache@v3
  #       with:
  #         path: '**/node_modules'
  #         key: ${{ runner.os }}-${{ hashFiles('**/yarn.lock') }}
  #     - name: Build Libs
  #       run: yarn build:libs
  #     - name: Build provider
  #       working-directory: packages/mobile
  #       run: yarn build:provider
  #     - name: Setup Ruby 
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         ruby-version: 2.6.10
  #         bundler-cache: true
  #     - uses: actions/cache@v1
  #       with:
  #         path: Pods
  #         key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-pods-
  #     - name: Pod install
  #       working-directory: packages/mobile
  #       run: yarn pod:install
  #     - name: Setup Fastlane ios
  #       working-directory: packages/mobile/ios/fastlane
  #       run: cd .. && bundle update && fastlane release
  #       env:
  #         DISCORD_HOOK_ID: ${{ secrets.DISCORD_MOBILE_WEBHOOK_ID }}
  #         DISCORD_HOOK_TOKEN: ${{ secrets.DISCORD_MOBILE_WEBHOOK_TOKEN }}
  #         APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
  #         APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
  #         APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
  #         APP_STORE_CONNECT_API_KEY_DURATION: 1200
  #         APP_STORE_CONNECT_API_KEY_IN_HOUSE: false
  #         APP_IDENTIFIER: io.orai.owallet
  #         APPLE_ID: ${{ secrets.APPLE_ID }}
  #         ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
  #         TEAM_ID: ${{ secrets.TEAM_ID }}
  #         MATCH_GIT_URL: "https://github.com/oraichain/fastlane.git"
  #         KEYCHAIN_PASSWORD: ${{ secrets.PASS_KEY_STORE }}
  #         MATCH_PASSWORD: ${{ secrets.PASS_KEY_STORE }}
  #         KEYCHAIN_NAME: "login"
  #         MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}

